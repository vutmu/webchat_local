<!DOCTYPE html>
<html class="h-100" lang="en">
<head>
    <meta charset="UTF-8">
    <title>WasmohWeb</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link  rel = "stylesheet" href =  "{{ url_for('static',filename='styles/base.css') }}">
</head>
<body class="h-100 main">
  <div class="container-fluid h-100">
      <div class="row h-25 x1">
        <span class="col-7 h-50" id="your_name">Добро пожаловать,{{data['name']}}!</span>
        <a class="col-3" href="../settings"><img src={{data['avatar']}} class="border border-danger" alt="avatar"></a>
          <button class="col-2 btn btn-secondary h-25" id="but2" type="button">Выйти</button>
      </div>
      <div class="overflow-auto min-h-50 h-50 messages"></div>
      <div class="row h-25">
        <textarea class="col-10 h-50" id="your_message" placeholder="введите текст" maxlength="1000"></textarea>
          <button class="col-2 btn btn-success h-50" id="but1" type="button">Отправить</button>
      </div>
  </div>
  <script>
    setInterval(get_mess,2000)

    function pretty_print(json)
    {
        let author=json['author']
        let body=json['body']
        let mstime=Math.round(json['posttime'])*1000
        let posttime=new Date(mstime)
        let myPattern = new RegExp("\\d{2}:\\d{2}");
        posttime=myPattern.exec(posttime.toString())
        return author+' написал(а) в '+posttime+':<br> '+body
    }
    //Изменить параметры пагинации

    function get_mess()
    {
        let last_id = 0;
        if ($("div").is(".messages div")){
            last_id = $('.messages > div:last-child').attr('id');
        }
        $.get("/base",{ subfunction:'get_mess',last_id: last_id}, function(response)
        {
            let messages = $.parseJSON(response);
            let posts=messages['posts'];
            if (posts=='-404') {window.location="/dbfail"};
            $.each(posts, function(index, value)
            {
                let mess_id=value['id']
                let ref="../profile/"+value['author']
                let d=$('<div>').attr("id",mess_id).attr("class","h-25 w-100 messblock")
                $('.messages').append(d);
                let avatar=value['avatar']
                let a= $('<a><img class = "img-fluid" src='+avatar+' alt="avatar"></a>').attr("href",ref).attr("class","ref")
                $('[id='+mess_id+'].messblock').append(a);
                let p=$('<p>').attr("class","h3 intext").html(pretty_print(value))
                $('[id='+mess_id+'].messblock').append(p);
                $('.messages').scrollTop(9999)
            });
        });
    }


    $(document).ready(function(){
        $("#but1").on('click',function (){
            let json_data = {subfunction:'send_mess',name: "{{data['name']}}", text: $('#your_message').val()};
            $.post("/base", json_data);
            $('#your_message').val("")
        })
        $('#your_message').keypress(function (e){
            let key = e.which;
            if(key == 13)
            {
                $('#but1').click();
                return false;
            }
        })

        $("#but2").on('click',function (){
            $.get("/base",{subfunction:'logout'},function (){
                window.location="/auth"
            })
        })
    })
</script>
</body>
</html>