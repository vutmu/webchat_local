<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WasmohWeb</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
</head>
<body >

<div style="">Добро пожаловать,<span id="your_name">{{user}}</span>!</div><br>
<img src="/static/images/reksar.png" alt="reksar" height="3%" width="3%"><br>
<input id="but2" type="button" value="выйти">
<p><label for="your_message">Введите текст:</label></p>
<p><textarea id="your_message" cols="200" maxlength="1000" rows="5"> </textarea></p>
<input id="but1" type="button" value="Отправить">

<div class="messages" style="width: 400px; height: 600px; overflow: auto;"></div>
<script>
    setInterval(get_mess,1000)

    function pretty_print(json)
    {
        let author=json['author'].toString()
        let body=json['body'].toString()
        return author+' написал: '+body
    }
    //Изменить параметры пагинации

    function get_mess()
    {
        let last_id = 0;
        if ($("div").is(".messages div")){
            last_id = $('.messages > div:last-child').attr('id');
        }
        $.get("/get_mess",{ last_id: last_id}, function(response)
        {
            let messages = $.parseJSON(response);
            let posts=messages['posts'];
            if (posts=='-404') {window.location="/dbfail"};
            $.each(posts, function(index, value)
            {
                let mess_id=value['id']
                let d=$('<div>').attr("id",mess_id).attr("class","messblock")
                $('.messages').append(d);
                let i=$('<img>').attr("class","inimage").attr("src","/static/images/reksar.png")
                $('[id='+mess_id+'].messblock').append(i);
                let p=$('<p>').attr("class","intext").html(pretty_print(value))
                $('[id='+mess_id+'].messblock').append(p);

            });
        });
    }


    $(document).ready(function(){
        $("#but1").on('click',function (){
            let json_data = {name: $('#your_name').text(), text: $('#your_message').val()};
            console.log(json_data)
            $.post("/send", json_data);
        })
        $("#but2").on('click',function (){
            $.get("/logout",function (){
                window.location="/index"
            })
        })

    })
</script>

</body>
</html>